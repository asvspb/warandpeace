# Руководство по развертыванию и настройке Telegram-бота "Война и мир"

Это руководство содержит исчерпывающие инструкции по установке, настройке и запуску Telegram-бота на вашем сервере с использованием Docker.

## 1. Предварительные требования

Перед началом убедитесь, что на вашем сервере установлены следующие компоненты:

- **Git:** Для клонирования репозитория.
  - *Проверка:* `git --version`
- **Docker:** Для контейнеризации и запуска приложения.
  - *Проверка:* `docker --version`
  - *Установка:* [Официальная инструкция по установке Docker](https://docs.docker.com/engine/install/)
- **Docker Compose:** Для управления мультиконтейнерными Docker-приложениями.
  - *Проверка:* `docker-compose --version`
  - *Установка:* [Официальная инструкция по установке Docker Compose](https://docs.docker.com/compose/install/)

## 2. Установка

### Шаг 1: Клонирование репозитория

Склонируйте репозиторий проекта на ваш сервер и перейдите в созданный каталог.

```bash
git clone https://github.com/asv-spb/warandpeace.git
cd warandpeace
```

### Шаг 2: Создание и настройка файла `.env`

Этот файл содержит все необходимые секретные ключи и настройки. **Он не должен отслеживаться системой контроля версий.**

1.  Создайте файл `.env` в корневой директории проекта:
    ```bash
    touch .env
    ```

2.  Откройте файл в текстовом редакторе (например, `nano`) и добавьте следующие переменные, заменив значения на ваши:

    ```ini
    # --- Telegram ---
    # Токен вашего Telegram-бота. Получается у @BotFather в Telegram.
    TELEGRAM_BOT_TOKEN=123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11
    
    # ID вашего Telegram-канала (публичного или частного).
    # Для публичного: @username
    # Для частного: -1001234567890 (как получить: https://stackoverflow.com/a/32572159)
    TELEGRAM_CHANNEL_ID=@your_channel_username
    
    # (Опционально) Ваш личный Telegram User ID для получения уведомлений об ошибках.
    # Можно получить у бота @userinfobot.
    TELEGRAM_ADMIN_ID=123456789
    # (Опционально) Несколько администраторов через запятую
    TELEGRAM_ADMIN_IDS=123456789,987654321

    # --- API для обработки текста ---
    # Укажите хотя бы один ключ API для работы функции суммирования.
    # Можно указать несколько ключей Google API через запятую для распределения нагрузки.
    GOOGLE_API_KEYS=your_google_api_key_1,your_google_api_key_2
    OPENROUTER_API_KEY=your_openrouter_api_key
    ```

### Шаг 3: Подготовка каталога для базы данных

Чтобы избежать проблем с правами доступа к файлу базы данных внутри Docker-контейнера, необходимо заранее создать каталог `database` и назначить ему правильные права.

Выполните эту команду в корне проекта:

```bash
mkdir -p database && sudo chown -R $(id -u):$(id -g) database
```

## 3. Запуск и управление ботом

### Сборка и первый запуск

Эта команда соберет Docker-образ (если он не собран) и запустит контейнер в фоновом режиме (`-d`).

```bash
docker-compose up --build -d
```

### Проверка статуса

Чтобы убедиться, что бот запущен и работает корректно:

```bash
docker-compose ps
```

Вы должны увидеть контейнер с именем `warandpeace-bot` и статусом `Up` или `Up (healthy)`.

### Просмотр логов

Для отслеживания работы бота в реальном времени или для диагностики ошибок используйте команду:

```bash
docker-compose logs -f
```
Нажмите `Ctrl+C`, чтобы выйти из режима просмотра логов.

### Остановка бота

Эта команда остановит и удалит контейнер, но сохранит все данные (базу данных), так как они находятся в примонтированном томе.

```bash
docker-compose down
```

## 4. Обновление бота

Для обновления бота до последней версии из репозитория выполните следующие шаги:

1.  **Получите последние изменения:**
    ```bash
    git pull origin main
    ```

2.  **Пересоберите и перезапустите контейнер:**
    ```bash
    docker-compose up --build -d
    ```

## 5. Устранение неполадок

- **Ошибка `permission denied` при доступе к `database/articles.db`:**
  - **Причина:** Неправильные права доступа к каталогу `database` на хост-машине.
  - **Решение:** Выполните команду `sudo chown -R $(id -u):$(id -g) database` в корне проекта.

- **Контейнер постоянно перезапускается (статус `Restarting`):**
  - **Причина:** Скорее всего, ошибка в конфигурации (`.env`) или критическая ошибка в коде.
  - **Решение:** Проверьте логи с помощью `docker-compose logs`. Ищите сообщения об ошибках, например, "Invalid Telegram token" или другие исключения Python. Убедитесь, что все переменные в `.env` заданы корректно.

- **Бот не отправляет сообщения в канал:**
  - **Причина 1:** Неправильный `TELEGRAM_CHANNEL_ID`.
  - **Причина 2:** Бот не является администратором в канале с правами на отправку сообщений.
  - **Решение:** Убедитесь, что ID канала указан верно и бот добавлен в администраторы канала.

## 6. Управление логированием и уведомлениями

Для снижения шума логов от `python-telegram-bot` и библиотек HTTP, а также для включения админ-уведомлений о сетевых ошибках, используются переменные окружения:

```ini
# Уровень логирования приложения: DEBUG, INFO, WARNING, ERROR, CRITICAL
LOG_LEVEL=INFO

# Включить подробные логи сторонних библиотек (по умолчанию выключено)
ENABLE_VERBOSE_LIB_LOGS=false

# Интервал троттлинга повторных админ-уведомлений (в секундах)
ADMIN_ALERTS_COOLDOWN_SEC=900
```

Подробнее см. `doc/LOGGING_AND_ALERTS_RU.md`.

## 7. Наполнение БД с начала года до сегодняшнего дня (Backfill)

Для исторической загрузки «сырых» статей за период с 1 января текущего года по текущую дату используйте встроенную CLI-команду `backfill-range`.

Рекомендуемый запуск через Docker (использует примонтированный каталог `./database`):

```bash
docker-compose run --rm telegram-bot \
  python3 scripts/manage.py backfill-range \
  --from-date "$(date +%Y)-01-01" --to-date "$(date +%F)"
```

Полезные последующие действия:

- Проверить базовую статистику:
```bash
docker-compose run --rm telegram-bot python3 scripts/manage.py status
```

- Запустить суммаризацию для загруженных статей за тот же период:
```bash
docker-compose run --rm telegram-bot \
  python3 scripts/manage.py summarize-range \
  --from-date "$(date +%Y)-01-01" --to-date "$(date +%F)"
```

Заметки:
- Команда идемпотентна: повторный запуск не создаст дублей (используется `canonical_link`).
- Операция может занять значительное время; прогресс и ошибки отражаются в логах и DLQ (`dlq-show`).
- Локальный запуск вне Docker не рекомендуется, т.к. путь БД зашит как `/app/database/articles.db` и предполагает контейнер.

## 8. Надёжность сети и новые параметры (Circuit Breaker, ретраи, очередь)

В боте внедрены механизмы устойчивости к сетевым сбоям Telegram API:

- **Circuit Breaker**: при серии сетевых ошибок исходящие запросы временно блокируются, чтобы избежать лавины ошибок; периодически выполняется пробная попытка. Сообщения в логах:
  - «Соединение стабильно, запросы к Telegram разрешены.»
  - «Соединение с Telegram восстановлено. Запросы к Telegram снова разрешены.»
- **Ретраи**: сетевые/временные ошибки (`NetworkError`, `TimedOut`, `RetryAfter`) повторяются с экспоненциальной задержкой.
- **Очередь публикаций**: при недоступности Telegram посты не теряются — складываются в БД и отправляются фоновым флашером после восстановления связи.

Важные изменения для развёртывания:

- Требуется установка extras для JobQueue: в `requirements.txt` используется `python-telegram-bot[job-queue]==21.4`.
- В `src/bot.py` JobQueue инициализируется явно; фоновые задачи:
  - `check_and_post_news` — основная обработка новостей
  - `flush_pending_publications` — отправка отложенных публикаций

Новые/уточнённые переменные окружения:

```ini
# Таймауты HTTP-клиента Telegram (HTTPXRequest)
TG_CONNECT_TIMEOUT=10
TG_READ_TIMEOUT=60
TG_WRITE_TIMEOUT=60
TG_POOL_TIMEOUT=60
TG_HTTP_VERSION=1.1

# Кол-во попыток при сетевых сбоях Telegram
TG_RETRY_ATTEMPTS=4

# Circuit Breaker
TG_CB_FAILURE_THRESHOLD=5        # сколько сбоев в окне
TG_CB_FAILURE_WINDOW_SEC=60      # окно для подсчёта сбоев
TG_CB_OPEN_COOLDOWN_SEC=30       # «остывание» перед пробной попыткой

# Прокси при необходимости
HTTPS_PROXY=http://user:pass@host:port
ALL_PROXY=socks5://user:pass@host:port
```

Структура БД дополнена таблицей `pending_publications` для отложенных публикаций.

## 9. Краткий список последних изменений

- Добавлены: Circuit Breaker, ретраи Telegram, очередь публикаций и фоновый флашер.
- Обновлена зависимость: `python-telegram-bot[job-queue]`.
- Улучшены логи предохранителя простым языком.
- Обновлена документация по переменным окружения и запуску.

## 8. Настройка сети и отказоустойчивости

Для тонкой настройки поведения бота при сетевых сбоях и для работы через прокси-серверы предусмотрены следующие переменные окружения.

### Таймауты Telegram API

Эти параметры позволяют управлять, как долго бот будет ждать ответа от серверов Telegram.

```ini
# Таймаут на установку соединения (секунды).
TG_CONNECT_TIMEOUT=10
# Таймаут на чтение ответа (секунды).
TG_READ_TIMEOUT=20
# Таймаут на запись/отправку данных (секунды).
TG_WRITE_TIMEOUT=20
# Таймаут на получение соединения из пула (секунды).
TG_POOL_TIMEOUT=10
```

### Circuit Breaker (Предохранитель)

Этот механизм защищает от лавинообразных ошибок при длительной недоступности Telegram.

```ini
# Количество сбоев подряд, после которых "предохранитель" размыкается.
TG_CB_FAILURE_THRESHOLD=5
# Временное окно для подсчета сбоев (секунды).
TG_CB_FAILURE_WINDOW_SEC=60
# Время, на которое блокируются запросы после размыкания (секунды).
TG_CB_OPEN_COOLDOWN_SEC=30
```

### Работа через прокси

Бот автоматически использует системные настройки прокси, если они заданы через стандартные переменные окружения.

```ini
# Пример для HTTP-прокси
HTTPS_PROXY=http://user:password@host:port

# Пример для SOCKS5-прокси
ALL_PROXY=socks5://user:password@host:port
```
