# План реализации системы очереди задач для суммаризации

## Обзор

В проекте реализована система фоновой обработки задач суммаризации с использованием Redis в качестве очереди задач. Это позволяет асинхронно обрабатывать задачи суммаризации, не блокируя основной поток выполнения и обеспечивая масштабируемость.

## Архитектура

### Компоненты системы

1. **API-эндпоинты** (`src/webapp/routes_summarization.py`)
   - `/api/summarization/enqueue` - добавляет задачу суммаризации в очередь
   - `/api/summarization/enqueue-batch` - добавляет несколько задач суммаризации
   - `/api/summarization/status/{job_id}` - возвращает статус задачи
   - `/api/summarization/queue-info` - возвращает информацию о состоянии очереди

2. **Система очередей** (`src/queue_workers.py`)
   - Использует Redis в качестве брокера сообщений
   - Реализует простую очередь задач с обработкой FIFO
   - Обрабатывает задачи суммаризации асинхронно

3. **Воркеры** (`scripts/start_summarization_workers.py`)
   - Отдельный процесс, который извлекает задачи из очереди и обрабатывает их
   - Может запускаться в нескольких экземплярах для масштабирования

4. **Интеграция с существующим кодом**
   - Модифицирован `src/summarizer.py` для поддержки фоновой обработки
   - Обновлены модели в `src/models.py` для отслеживания статуса задач
   - Обновлена конфигурация в `src/config.py` для подключения к Redis

## Реализация

### Очередь задач

Система использует Redis списки (Redis Lists) в качестве очереди задач:
- Задачи помещаются в очередь с помощью `LPUSH`
- Воркеры извлекают задачи с помощью `BRPOP` (блокирующий POP с таймаутом)
- Формат задачи: JSON-объект с информацией о статье и метаданными

### Статусы задач

Для отслеживания статуса задач используется перечисление `SummaryStatus`:
- `PENDING` - задача находится в очереди
- `OK` - задача успешно выполнена
- `FAILED` - задача завершена с ошибкой

Статусы хранятся в таблице `summaries` в базе данных PostgreSQL.

### Безопасность и надежность

- Все API-эндпоинты защищены с использованием существующей системы аутентификации
- Воркеры обрабатывают ошибки и устанавливают соответствующий статус задач
- Используется таймаут при извлечении задач из очереди, чтобы избежать блокировки

## Запуск и эксплуатация

### В Docker Compose

Система включает новый сервис `summarization-workers` в `docker-compose.yml`:
```yaml
summarization-workers:
  build: .
  command: python3 scripts/start_summarization_workers.py --workers 2
  environment:
    - REDIS_URL=redis://redis:6379/0
    - DATABASE_URL=postgresql+psycopg://wp:${POSTGRES_PASSWORD}@postgres:5432/warandpeace
  depends_on:
    - redis
    - postgres
```

### Конфигурация

Для работы системы требуются следующие переменные окружения:
- `REDIS_URL` - URL для подключения к Redis
- Переменные для подключения к базе данных
- Переменные для доступа к LLM API (Google Gemini, Mistral и т.д.)

## API Примеры

### Постановка задачи в очередь

```bash
curl -X POST "http://localhost:8080/api/summarization/enqueue?article_id=123" \
  -H "X-API-Key: your-api-key"
```

### Проверка статуса задачи

```bash
curl -X GET "http://localhost:8080/api/summarization/status/summarize_123_1692345678" \
 -H "X-API-Key: your-api-key"
```

### Постановка нескольких задач

```bash
curl -X POST "http://localhost:8080/api/summarization/enqueue-batch" \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-api-key" \
  -d '[123, 124, 125]'
```

## Мониторинг и логирование

- Все операции с очередью логируются
- Статусы задач хранятся в базе данных и могут быть отслежены
- Воркеры логируют начало и завершение обработки задач

## Возможные улучшения

1. Использование более продвинутого брокера сообщений (например, Celery с Redis/RabbitMQ)
2. Добавление возможности приоритезации задач
3. Реализация повторных попыток для неудачных задач
4. Добавление метрик производительности очереди