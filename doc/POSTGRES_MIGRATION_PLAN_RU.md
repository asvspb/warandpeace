## План миграции на PostgreSQL (с сохранением пути отката)

Цель: перевести хранилище с SQLite на PostgreSQL без простоев, с контролируемой миграцией данных и плавной сменой кода доступа к БД.

### 1) Область и допущения
- Python остаётся 3.11+ (см. `PY311_MIGRATION_PLAN.md`).
- Используем SQLAlchemy 2.x + Alembic для ORM/миграций.
- PostgreSQL 14+ (prod), 15+ (dev/stage) — совместимо.

### 2) Архитектурные изменения
- Ввести абстракцию доступа к БД через слой репозиториев/сервисов (`src/db/session.py`, `src/db/models.py`, `src/db/repo/*.py`).
- SQLAlchemy модели на основе текущей схемы `articles`, `dlq`, `digests`, `pending_publications`.
- Конфиг строки подключения через `DATABASE_URL` в `.env` (sqlite/postgres переключаемо).

### 3) Шаги реализации
- Кодовая база:
  - [ ] Добавить `sqlalchemy>=2`, `alembic`, `psycopg2-binary` в `requirements.txt`.
  - [ ] Создать `src/db/models.py` и описать модели.
  - [ ] Создать `src/db/session.py` (создание engine/sessionmaker, чтение `DATABASE_URL`).
  - [ ] Реализовать тонкие репозитории (чтение/запись) поверх сессии.
  - [ ] Заменить точки использования `sqlite3` (в `src/database.py`) на репозитории, оставив назад-совместимые фасады.
- Alembic:
  - [ ] Инициализировать Alembic (если не инициализирован) и настроить env на SQLAlchemy metadata.
  - [ ] Сгенерировать миграцию v1 (создание таблиц) + индексы/уникальные ключи.
- Данные:
  - [ ] Одноразовый ETL-скрипт миграции из SQLite в Postgres (bulk-вставка партиями; контроль дубликатов по `canonical_link`).
  - [ ] Временная блокировка записи на миграцию (флаг в конфиге).
- Конфигурация:
  - [ ] В `.env.example` добавить `DATABASE_URL` (пример для Postgres/SQLite).
  - [ ] Обновить `docker-compose.yml`: сервис `postgres` (+ volume), переменные окружения.

### 4) План тестирования
- [ ] Интеграционные тесты поверх временной Postgres (docker service) — CRUD/индексы/уникальность.
- [ ] E2E: старт бота/веба с Postgres, публикация/чтение статей, DLQ, метрики.
- [ ] Производительность: инжест 1k статей, контроль времени.<

### 5) Наблюдаемость/операции
- Метрики подключения к БД (pg_stat, latency запросов) — через экспортер или логирование timings.
- Бэкап: см. `CLOUD_BACKUP_PLAN_RU.md`.

### 6) Риски и откат
- Несоответствие типов/уникальностей — строгие индексы, dry-run ETL.
- Откат: переключение `DATABASE_URL` назад на SQLite, сохранить файл БД/бэкап перед миграцией.

### 7) Чек-лист внедрения
- [ ] Завести Postgres (compose) и прогнать Alembic.
- [ ] Перенести данные ETL-скриптом.
- [ ] Переключить приложение на Postgres.
- [ ] Мониторинг/логи, затем удаление legacy пути `sqlite3`.