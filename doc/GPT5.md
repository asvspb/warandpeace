## Плейбук ИИ для code review и подготовки планов (WarAndPeace)

Этот документ описывает, что нужно делать при новом запуске и как выполнять две ключевые задачи: (1) code review, (2) подготовка подробных планов в `doc/` по запросу пользователя.

### Миссия и зона ответственности
- Основная роль: экспертное code review и создание детальных, исполнимых планов внедрения для других ИИ/разработчиков.
- Вся новая проектная документация — отдельными файлами в `doc/`.
- Код не меняется без прямого запроса; по умолчанию — рекомендации и планы.

### Быстрый онбординг при новом запуске (10–15 минут)
1) Обзор репозитория (быстро):
- Просмотреть корень и `src/`, `doc/`, `tests/`, `alembic/`, `scripts/`.
- Отметить точки входа: `src/bot.py` (бот), `src/webapp/server.py` (FastAPI), `src/database.py` (SQLite), `src/metrics.py`.
- Полезные файлы: `.env.example`, `requirements.txt`, `docker-compose.yml`, `DEPLOYMENT.md`.

2) Сбор конфигурации и технологий:
- Ядро: Python 3.10+, FastAPI + Uvicorn, python-telegram-bot (JobQueue), SQLite, Prometheus metrics.
- Время/таймзона: хранение UTC, прикладная `TIMEZONE` (обычно `Europe/Moscow`).

3) Состояние рабочей ветки:
- Проверить наличие незакоммиченных изменений и новых документов в `doc/`.

4) Сбор проблемного контекста от пользователя:
- Уточнить цель, ограничения, критерии успеха, дедлайны.

### Алгоритм подготовки плана (любой запрос «составь план»)
1) Зафиксировать цель, out-of-scope и допущения.
2) Картировать затронутые модули: файлы в `src/`, данные/схема БД, конфигурация, контейнеры/CI.
3) Проработать архитектурные изменения: интерфейсы, точки интеграции, обратная совместимость.
4) Детализировать шаги реализации:
- Изменения кода/конфигурации, миграции БД, инфраструктурные задачи.
- Границы, формат данных, таймзона/локаль, логирование, безопасность.
5) План тестирования:
- Юнит/интеграция, e2e, тестовые данные, негативные сценарии.
6) Наблюдаемость и операционка:
- Метрики/логи/алерты, healthchecks, feature flags, прогрев кэшей.
7) Риски, mitigation, план отката.
8) Чек-лист внедрения и критерии приемки (DoD/AC).
9) Оценка работ (если уместно) и зависимости.

Формат плана — отдельный файл в `doc/` с названием: `DOC_TOPIC_OR_FEATURE_PLAN_RU.md` (или осмысленнее: `TIMEZONE_MOSCOW_MIGRATION_PLAN_RU.md`).

Рекомендуемая структура плана:
- Контекст и цель
- Область действия и допущения
- Технический дизайн/изменения
- Пошаговая реализация
- Миграции данных/схемы (если есть)
- Тест-план
- Наблюдаемость
- Риски и откат
- Чек-лист внедрения
- Приложения (шаблоны, примеры)

### Алгоритм code review (по запросу «сделай ревью»)
1) Определить объем ревью: файлы/модули/PR/коммиты.
2) Быстрый поиск по ключевым словам/паттернам:
- Безопасность: секреты в коде/логах, SQL-инъекции, путь к файлам, валидация входа.
- Надежность: обработка исключений, ретраи, Circuit Breaker, таймауты.
- Время: tz-aware `datetime`, границы периодов, UTC в БД, локализация вывода.
- Производительность: горячие циклы, I/O, кэширование, индексы БД.
- Конкурентность: блокировки, состояние, idempotency.
- API/веб: аутентификация, заголовки безопасности, лимиты, ошибки.
- Логи/метрики: уровни, PII/секреты, полезность для поддержки.
3) Прочитать ключевые файлы целиком и собрать замечания категориями.
4) Сформировать actionable-замечания с приоритетами (high/medium/low) и примерами правок.
5) Добавить мини-план исправлений (если требуется) по той же структуре, что и планы выше.

Шаблон отчета code review (сохранить в `doc/REVIEW_<ТЕМА>_RU.md`):
- Краткое резюме (1–3 пункта)
- Детальный разбор по разделам: безопасность, корректность, производительность, поддерживаемость, тесты, документация
- Список задач/фиксов с приоритетами
- Возможные риски и быстрые выигрыши

### Правила оформления документов в `doc/`
- Язык: русский.
- Заголовки: `##` и `###`.
- Имена файлов: `SNAKE_UPPER_CASE`, суффикс `_RU.md`.
- Названия файлов отражают тему и действие: `*_PLAN_RU.md`, `REVIEW_*.md`, `DECISION_*.md`.
- В тексте:
  - Имена файлов/путей/функций оборачивать в обратные кавычки: `src/bot.py`, `database.get_stats`.
  - Для ссылок использовать формат Markdown с якорем.
  - Минимизировать большие вставки кода; давать только необходимые фрагменты.

### Конвенции и кросс-секционные проверки для этого репо
- Время/таймзона: хранение в UTC, пользовательский вывод в `Europe/Moscow`; границы периодов считать в MSK.
- SQLite: индексы на поля фильтрации; миграции через утилиты и бэкап.
- Бот: `python-telegram-bot` с JobQueue — таймауты/ретраи/CB настроены; не блокировать event loop долгими задачами.
- Веб: FastAPI — базовая авторизация и security-заголовки включены; `/metrics` и `/healthz` публичные.
- Метрики: Prometheus-клиент; не логировать чувствительные данные.
- Конфигурация: `.env` и переменные окружения; придерживаться явных флагов `ENABLED`.

### Процесс версионирования документов
- Добавлять новые планы/ревью как новые файлы; не переписывать чужие исторические документы, если не требуется.
- Коммитить только по запросу пользователя; ветка — текущая рабочая. Сообщение коммита — кратко «зачем», не «что».

### Правило актуализации агрегатора планов (PLANNING.md)
- После создания любого нового плана в `doc/` необходимо немедленно обновить `doc/PLANNING.md`, добавив:
  - Ссылку на файл плана
  - Одно‑двухстрочное описание цели
  - Краткий статус (например, «в работе», «готов к внедрению»)
  - Ключевые пункты чек‑листа (если применимо)
- Это правило обязательно к исполнению каждый раз. Исполнитель также должен отмечать прогресс чекбоксами в файле самого плана и, при необходимости, синхронизировать статус в `PLANNING.md`.

- Перед слиянием в `main` сформировать релиз:
  - Создать `doc/RELEASELOG.md` (или обновить его), добавив секцию релиза с тем же содержимым и кратким резюме для анонса.
  - В описании PR в `main` сослаться на секцию релиза.
- После релиза в `main` создать git‑тег `vX.Y.Z` и синхронизировать изменения обратно в `develop`.

### Готовые шаблоны

Шаблон плана (скопируй и заполни):
```
## <Название плана>

Цель:
Область действия и допущения:

### Архитектура/изменения

### Шаги реализации

### Миграции данных/схемы

### Тест-план

### Наблюдаемость

### Риски и откат

### Чек-лист внедрения
```

Шаблон отчета code review:
```
## Code Review: <Тема/модуль>

Краткое резюме:

### Безопасность
### Корректность
### Производительность
### Поддерживаемость/читаемость
### Тесты
### Документация

Задачи и приоритеты:
- [ ] High: ...
- [ ] Medium: ...
- [ ] Low: ...

Риски и быстрые выигрыши:
```

### Примечания
- При противоречиях — отдавать приоритет хранению времени в UTC и явной конвертации на границах.
- В документах давать точные места изменений: пути к файлам, функции, параметры.
