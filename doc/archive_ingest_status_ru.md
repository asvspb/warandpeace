## Статус выполнения плана: archive_ingest_plan_ru

Документ фиксирует, что из плана реализовано, что отсутствует и какие следующие шаги предлагаются.

### Обзор
- Текущий стек реализует сбор, хранение, суммаризацию, базовые бэкапы и веб‑интерфейс.
- Полный оркестратор архивного инжеста, модель батчей/сверок и детальные статусы резюме пока отсутствуют.

### Реализовано (основное)
- Инжест и backfill (ручные команды):
  - `scripts/manage.py`: `ingest-page`, `backfill-range`, `reconcile`, `summarize-range`, отчёты по дубликатам и DLQ.
  - Идемпотентный upsert в `articles` с `content_hash` и индексами.
  - DLQ: запись ошибок и ретраи.
- Суммаризация и дайджесты:
  - `src/summarizer.py` с поддержкой Gemini/Mistral, промпты из `prompts/` (`summarization_ru.txt`, digest_*).
- База данных и утилиты:
  - Таблицы: `articles`, `dlq`, `digests`, `pending_publications` + индексы. Инициализация/миграции в `src/database.py`.
- Бэкапы (локальный backend):
  - `tools/backup.py` — локальные зашифрованные бэкапы `.env` и SQLite‑БД, ротация, checksums.
- Веб‑интерфейс (FastAPI + Jinja2):
  - Календарь месяца и суточная лента: маршруты `/calendar`, `/articles` (календарь), `/day/{YYYY-MM-DD}`.
  - Недельный статус резюмирования на календаре (по факту заполнения `summary_text`).
  - Разделы `Дубликаты`, `DLQ`, базовая авторизация, метрики и защитные заголовки.

### Не реализовано / требует доработки по плану
- Модель батчей и статусов:
  - Отсутствуют таблицы: `ingest_batches`, `article_summaries` (со статусами SUCCEEDED/FAILED/PENDING), `verifications`, `system_settings`.
  - Нет явной связи «статья → батч», нет статусов и прогресс‑баров на уровне батчей/периодов.
- Оркестратор архивного инжеста:
  - Нет единого цикла «Сегодня (с резюмированием) → фоновые окна назад до ARCHIVE_DATE_GOAL», нет логики «закрытия суток» и процента прогресса.
- Ежемесячная сверка полноты:
  - Нет таблицы/процесса `verifications` и UI/метрик по результатам сверок.
- Бэкапы в удалённые хранилища:
  - В `tools/backup.py` не реализованы backend `s3`/`yadisk`; нет связки батч→бэкап‑артефакт.
- Админ‑мутации и безопасность:
  - Нет X‑Admin‑Key и действий в UI (добавить/перерезюмировать, повторная суммаризация из интерфейса).
- UI прогресс архива:
  - Нет прогресс‑панели заполнения архива до `ARCHIVE_DATE_GOAL`; статусы резюмирования считаются по `summary_text`, а не по `article_summaries`.

### Предлагаемые следующие шаги (минимально жизнеспособный контур)
1. Схема БД и миграции:
   - Добавить таблицы `ingest_batches`, `article_summaries`, `verifications`, `system_settings` и индексы.
   - Миграция для бэкапов/сверок (при необходимости).
2. Оркестратор:
   - Реализовать цикл: мониторинг T (с суммаризацией) + фоновые окна (вчера/неделя/месяц/история) до `ARCHIVE_DATE_GOAL`.
   - Логика «закрытия суток» и триггер дневного бэкапа.
3. Сверка полноты:
   - Импорт эталона, запись результата в `verifications`, формирование задач на дозакачку.
4. Бэкапы:
   - Реализовать backend `s3`/`yadisk` в `tools/backup.py`; связать батчи с снапшотами.
5. UI и API:
   - Прогресс архива (процент и диапазон), таблица статусов резюмирования по `article_summaries`.
   - Админ‑действия с защитой `X-Admin-Key`.
6. Планировщик:
   - Добавить cron/сервис запуска оркестратора, мониторинга, бэкапов, сверок (см. расписания в плане).

### Примечания по текущему UI
- `Календарь` интегрирован на `/articles` и `/calendar`; день клика ведёт на `/day/YYYY-MM-DD`.
- Недельный статус строится по доле статей с непустым `summary_text` за неделю.

### Ссылки на основные файлы
- Консоль: `scripts/manage.py`
- БД/инициализация: `src/database.py`
- Суммаризация: `src/summarizer.py`
- Веб‑сервер/маршруты: `src/webapp/server.py`, `src/webapp/routes_articles.py`
- Шаблоны UI: `src/webapp/templates/`
- Бэкапы: `tools/backup.py`
- План: `doc/archive_ingest_plan_ru.md`
