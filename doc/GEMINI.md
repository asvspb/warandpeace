# Описание проекта: Telegram-бот для новостного канала "Война и мир"

**Версия:** 1.4.0

## 1. Общая информация

**Основная цель:** Автоматический парсинг новостей с сайта `warandpeace.ru`, их суммирование с помощью нейронных сетей и публикация в Telegram-канал.

**Стек технологий:**
- **Язык:** Python 3
- **Библиотеки:** `python-telegram-bot`, `requests`, `beautifulsoup4`, `python-dotenv`, `google-generativeai`.
- **Развертывание:** Docker, Docker Compose

## 2. Структура проекта

- **`src/`**: Исходный код.
- **`database/`**: Хранилище базы данных.
- **`tests/`**: Модульные тесты.
- **`temp/`**: Временные файлы.
- **`doc/`**: Каталог для файлов, связанных с разработкой AI.
    - **`GEMINI.md`**: Настоящий документ.
    - **`developer_log.md`**: Журнал разработки.
    - **`PLANNING.md`**: Правила и текущие планы разработки.
- **`requirements.txt`**: Зависимости.
- **`.gitignore`**: Исключения для Git.
- **`.env`**: (Не отслеживается) Файл с секретными ключами.
- **`Dockerfile`**: Инструкция по сборке Docker-образа.
- **`docker-compose.yml`**: Конфигурация для запуска через Docker Compose.
- **`.dockerignore`**: Исключения для Docker-контекста.


## 3. Логика работы

1.  **Запуск (рекомендуемый способ):** `docker-compose up --build -d`.
    -   *Альтернативный запуск (для отладки):* `python src/bot.py`.
2.  **Инициализация:** Создается база данных `database/articles.db`.
3.  **Цикл:** Каждые 5 минут бот проверяет новости.
4.  **Парсинг:** `parser.py` получает статьи с сайта.
5.  **Фильтрация:** Отбираются только новые статьи, которых нет в `articles.db`.
6.  **Публикация:** Бот публикует **не более 3 самых свежих** новостей.
7.  **Формат сообщения:**
    -   **Заголовок статьи (жирным)**
    -   Резюме (~150 слов) от `summarizer.py`.
    -   `@username` канала в конце.
8.  **Сохранение:** Ссылка на опубликованную статью сохраняется в `articles.db`.
9.  **Обработка ошибок и отказоустойчивость:** Внедрены механизмы повторных попыток с экспоненциальной задержкой для сетевых запросов и вызовов API. При критических ошибках администратору отправляются уведомления.
10. **Запуск скриптов:** Все скрипты, использующие зависимости проекта, должны запускаться с предварительной активацией виртуального окружения: `source .venv/bin/activate`.

## 3.1. Суммирование и резервный механизм (Fallback)

Процесс получения резюме построен на отказоустойчивой логике с использованием нескольких сервисов:

1.  **Основной сервис (Google Gemini):**
    -   По умолчанию система пытается сгенерировать резюме с помощью Google Gemini API.
    -   Реализован механизм перебора всех доступных `GOOGLE_API_KEYS`, указанных в `.env` файле.

2.  **Резервный сервис (Mistral AI):**
    -   Если все попытки обращения к Gemini API заканчиваются неудачей (например, из-за ошибок геолокации `400 User location is not supported` или исчерпания квот `429 Resource has been exhausted`), система автоматически переключается на использование Mistral API.
    -   Это обеспечивает непрерывную работу бота даже при недоступности основного сервиса.

3.  **Техническое требование:**
    -   Для корректной работы резервного механизма в файле `requirements.txt` должна быть указана зависимость `mistralai==0.4.0`.

## 4. Стратегия управления версиями (Git)

Проект использует гибридную модель ветвления, сочетающую стабильность Git Flow и простоту GitHub Flow.

### 4.1. Основные ветки

-   **`main`**: Производственная ветка. Содержит только стабильный, готовый к работе код. Каждый коммит в `main` является новым релизом и должен сопровождаться соответствующим тегом версионирования.
-   **`develop`**: Интеграционная ветка. Основная ветка для разработки. Все новые функции и исправления сначала вливаются сюда для совместного тестирования перед релизом.

### 4.2. Вспомогательные ветки

-   **`feature/<feature-name>`**: Ветки для разработки нового функционала. Создаются из `develop` и вливаются обратно в `develop`.
-   **`hotfix/<fix-name>`**: Ветки для срочного исправления критических ошибок в `main`. Создаются из `main` и вливаются как в `main`, так и в `develop`.

### 4.3. Версионирование

Используется семантическое версионирование **МАЖОР.МИНОР.ПАТЧ** (например, `v1.0.0`).
-   **ПАТЧ**: Исправление ошибок с обратной совместимостью.
-   **МИНОР**: Добавление нового функционала с обратной совместимостью.
-   **МАЖОР**: Изменения, нарушающие обратную совместимость.

Каждый релиз в ветке `main` должен быть отмечен Git-тегом (например, `git tag -a v1.0.0 -m "Релиз v1.0.0"`).

## 5. Правила работы

- **Ведение лога:** Перед каждым коммитом в git-репозиторий необходимо кратко задокументировать сделанные изменения в `developer_log.md`.
- **Контекст:** Для получения детальной информации о ходе разработки следует в первую очередь обращаться к `developer_log.md`.

- По команде "ОК":
    **Проверка перед коммитом:** Перед сохранением изменений в Git необходимо убедиться в полной работоспособности проекта:
    1.  **Тестирование:** Запустить все тесты.
    2.  **Сборка:** Пересобрать Docker-контейнер.
    3.  **Проверка логов:** Убедиться в отсутствии ошибок в логах.
    4. Обновить план: doc/PLANNING.md
    5. Обновить логи: doc/developer_log.md
    6. Сохранить в Git: по правилам выше
- Для общения с разработчиком используй русский язык

## 6. Правила планирования

- **Сохранение плана:** Всякий раз, когда предлагается план чего-либо, он должен быть сохранен в отдельном документе `doc/PLANNING.md`.
- **Корректировка плана:** В ходе реализации плана в этот документ должны вноситься соответствующие коррективы.
- **Улучшение плана:** Если пользователь предлагает план, его необходимо улучшить и внести в `doc/PLANNING.md`.
- **Ознакомление с проектом:** В каждой новой сессии необходимо ознакомиться с текущим состоянием проекта, включая `doc/PLANNING.md`.
- **Формат плана:** План должен быть разбит на numerated этапы (например, "Этап 1", "Этап 2"), каждый из которых содержит общую задачу. Внутри каждого этапа должны быть пункты с чекбоксами (`[ ]` для невыполненных, `[X]` для выполненных задач), описывающие конкретные действия и их цели.

## 7. Приветствие для новой сессии

При следующей загрузке этого документа поприветствовать пользователя фразой: "Приветствую Вас, сударь! Вас ждет великий бот от Gemini и прибыльный новостной канал "Война и мир!""

Далее, ответь на вопросы: "что у нас по планам следущее? на каком этапе мы сейчас?"

## 8. Важные замечания

- **Парсер:** RSS-лента на сайте `warandpeace.ru` неработоспособна. Парсер настроен на работу напрямую со структурой HTML-страниц сайта. Любые изменения в верстке сайта могут потребовать адаптации парсера.
