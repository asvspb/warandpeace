## Плейбук ИИ-исполнителя инструкций (WarAndPeace)

Цель документа: дать четкий алгоритм для ИИ, который будет исполнять планы/инструкции из `doc/` и комментарии code review. Исполнитель должен строго следовать шагам, безопасно вносить изменения и подтверждать результат тестами и сборкой.

### 0) Приветствие (согласно GEMINI.md)
- При старте новой сессии выведи: "Приветствую Вас, сударь! Вас ждет великий бот от Gemini и прибыльный новостной канал \"Война и мир!\""
- Сразу спроси: "что у нас по планам следующее? на каком этапе мы сейчас?" и просмотри `doc/` + `git status` для контекста.

### 1) Стандартный рабочий цикл исполнителя
1. Получить задачу из последнего плана в `doc/` или прямого запроса пользователя.
2. Уточнить допущения и критерии приемки (если не очевидны из плана).
3. Синхронизировать состояние:
   - Проверить `git status`, `git log -n 10`, рабочую ветку (обычно `develop`).
   - Прочитать относящиеся документы: `doc/PLANNING.md`, тематический `*_PLAN_RU.md`, `doc/GEMINI.md`.
4. Подготовить рабочую ветку:
   - Если нужно — создать `feature/<topic>` от `develop`.
5. Исполнить задачу по шагам из плана:
   - Изменения в коде — минимально необходимые, согласно плану.
   - Следовать конвенциям времени: хранение UTC, вывод в Europe/Moscow.
   - Обновить конфиги/Compose/Dockerfile, если план этого требует.
6. Прогнать проверки:
   - Запустить тесты: `pytest -q`.
   - Локально собрать контейнер: `docker-compose build` (если применимо).
   - Запустить сервисы и проверить `/healthz`, лог ошибок.
7. Обновить документацию:
   - Отметить выполнение шагов (чекбоксы) в соответствующем файле плана в `doc/`.
   - Если были отклонения — зафиксировать их и причины.
8. Коммит/PR:
   - Коммитить атомарно с сообщением, отражающим цель (почему), а не только что изменено.
   - Создать PR в `develop` с кратким описанием и планом тестирования.

### 2) Правила изменения кода
- Не вносить правки вне области текущего шага плана.
- Добавлять импорты и зависимости явно. Для pip — править `requirements.txt` и фиксировать совместимые версии.
- Не хранить секреты в коде. Секреты — только в `.env`.
- Логи и метрики: не писать PII/секреты, придерживаться существующих метрик; новые метрики — обоснованно.
- Для времени использовать `zoneinfo`; хранить UTC; вычисления пользователю — в Europe/Moscow.

### 3) Работа с БД (SQLite)
- Перед миграциями делать резервную копию (`database/articles.db` → `*.bak-<ts>`), можно вызвать `backup_database_copy()`.
- Миграции совместимы вперед/назад, когда возможно.
- Индексы на поля фильтрации/сортировки.

### 4) Тестирование
- Обязательно запускать `pytest`. Конфигурация уже задана в `pytest.ini` (`pythonpath = . src`).
- Писать тесты для нового кода, если план требует.
- Граничные случаи: пустые данные, ошибки сети/Telegram API, таймзона около полуночи MSK.

### 5) Контейнеризация и запуск
- Docker/Compose — основной путь; проверять `docker-compose.yml` изменения переменных окружения.
- Убедиться, что `TZ=Europe/Moscow` и `TIMEZONE=Europe/Moscow` корректно выставлены, если требуется.

### 6) Git-процесс
- Ветки: `develop` — основная для интеграции; фичи — `feature/<name>`.
- Коммиты атомарные, сообщения в стиле: "Update/Refactor/Fix/Add: краткое объяснение причины".
- PR с чек-листом тест-плана и кратким описанием изменений.

### 7) Эскалация и консультации
- Если шаг плана неясен — задать вопрос в комментариях к документу плана или сформулировать предположения и зафиксировать их в том же документе.
- При критических рисках предложить альтернативный вариант и согласовать в документе.

### 8) Быстрые шпаргалки
- Запуск бота локально: `python src/bot.py`
- Запуск веба локально: `uvicorn src.webapp.server:app --reload --port 8080`
- Тесты: `pytest -q`
- Сборка: `docker-compose build`
- Поднятие: `docker-compose up -d`
- Метрики: `http://localhost:8000/metrics`, Health: `http://localhost:8080/healthz`

### 9) Чек-лист готовности изменений (DoD)
- [ ] Все тесты проходят локально.
- [ ] Обновлен(ы) `doc/*PLAN*_RU.md` чекбоксами по выполненным пунктам.
- [ ] Нет утечек секретов/PII в коде/логах.
- [ ] Линт/формат (при наличии) чистые.
- [ ] Релевантные метрики/логи присутствуют.
- [ ] Коммит/PR оформлены и описаны.

### 10) Важные замечания из GEMINI.md
- При сбоях Gemini переключаться на Mistral; убедиться, что `mistralai` указан в `requirements.txt` (версии совпадают с документацией).
- `git log` — первичный источник контекста по истории изменений и планам.
- Планирование: поддерживать `doc/PLANNING.md` в актуальном виде и отражать прогресс чекбоксами.
