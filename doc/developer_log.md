### 2025-08-06 - feat: Реализован CLI-инструмент `manage.py`

**Описание:**
Создан мощный и отказоустойчивый инструмент командной строки `manage.py` на базе библиотеки `click` для управления историческими данными и мониторинга состояния базы данных. Это ключевое улучшение для администрирования и обслуживания проекта.

**Изменения:**
1.  **`manage.py`**:
    *   Создан новый файл `manage.py` в корне проекта.
    *   Реализована основная команда `backfill` для парсинга и суммирования всех необработанных статей в базе данных. Команда имеет интерактивный режим с запросом подтверждения.
    *   Реализована вспомогательная команда `retry_failed` для повторной обработки только тех статей, которые ранее завершились с ошибкой.
    *   Реализована команда `status` для вывода детальной статистики по базе данных, включая общее количество статей и разбивку по статусам (`success`, `failed`, `pending`).
2.  **`src/database.py`**:
    *   Проведена миграция схемы данных: в таблицу `articles` добавлено поле `backfill_status` со значениями `success`, `failed`, `skipped`.
    *   Функция `init_db` обновлена для автоматической и безопасной миграции схемы без потери данных.
    *   Добавлены новые функции `get_articles_for_backfill` и `update_article_backfill_status` для поддержки нового CLI-инструмента.
    *   Функция `get_stats` была полностью переписана для корректного подсчета и вывода статистики по новым статусам.
3.  **`src/config.py`**:
    *   Улучшена логика загрузки переменных окружения для корректной работы при запуске скриптов из корневой директории проекта.
4.  **`requirements.txt`**:
    *   Добавлена новая зависимость `click`.

**Проблемы и решения в процессе разработки:**
*   **Проблема:** Скрипт `manage.py` падал с ошибками `ModuleNotFoundError` и `ValueError`, не находя модули и переменные окружения.
*   **Диагностика:** Путем создания и запуска временного отладочного скрипта `temp/debug_env.py` было установлено, что проблема не в коде, а в синтаксисе файла `.env` и в правах доступа к файлу БД.
*   **Решение:**
    1.  Были предоставлены точные инструкции по исправлению синтаксиса переменных `GOOGLE_API_KEY...` в файле `.env`.
    2.  Была диагностирована проблема с правами доступа к файлу `database/articles.db` (владельцем был `root`).
    3.  Была предоставлена команда `sudo chown` для смены владельца файла, что окончательно решило проблему.
*   **Проблема:** Скрипт падал с ошибкой `429 You exceeded your current quota`.
*   **Решение:** Это не было ошибкой. Система переключения ключей API в `src/summarizer.py` отработала штатно, автоматически переключившись на рабочий ключ и продолжив выполнение.

---

### 2025-08-06 - feat: Реализована точная логика дайджестов за календарный период

**Описание:**
Переработана логика генерации дайджестов. Вместо плавающего окна ("последние 24 часа") теперь используются строгие календарные периоды: "вчерашний день", "прошлая неделя (пн-вс)", "прошлый месяц". Это обеспечивает предсказуемость и консистентность результатов.

**Изменения:**
1.  **`src/database.py`**:
    *   Функция `get_summaries_for_period` заменена на `get_summaries_for_date_range`, которая принимает точные временные рамки (start_date, end_date).
2.  **`src/bot.py`**:
    *   Полностью переписаны обработчики команд `/daily_digest`, `/weekly_digest`, `/monthly_digest`.
    *   Реализована логика вычисления точных дат для "вчера", "прошлой недели" и "прошлого месяца".
    *   Обновлены описания команд в меню бота.
3.  **`tests/test_database.py`**:
    *   Обновлены тесты для соответствия новым сигнатурам функций (`add_article`).
4.  **`temp/`**:
    *   Удален устаревший тестовый файл `manual_digest_test.py`, который вызывал ошибки сборки.
5.  **`.env`**:
    *   Исправлена синтаксическая ошибка в переменной `GOOGLE_API_KEYS`, которая мешала сборке Docker-контейнера.

---

### 2025-08-06 - Улучшение документации

**Описание:**
В рамках улучшения проекта была переписана и значительно дополнена документация по развертыванию.

**Изменения:**
1.  **`DEPLOYMENT.md`**:
    *   Документ был полностью переработан для большей ясности и полноты.
    *   Добавлены пошаговые инструкции по установке, включая проверку предварительных требований (git, Docker, Docker Compose).
    *   Детализирован процесс настройки файла `.env` с примерами и пояснениями для каждой переменной.
    *   Включен раздел по устранению распространенных неполадок, таких как проблемы с правами доступа к базе данных и ошибки при запуске контейнера.
    *   Добавлен раздел по обновлению бота до последней версии.

---

### 2025-08-06 - Очистка кодовой базы (ветка `main`)

**Описание:**
В рамках портирования улучшений из ветки `develop` был выполнен первый этап - очистка кодовой базы ветки `main` от неиспользуемого кода и зависимостей.

**Изменения:**
1.  **`src/parser.py`**:
    *   Удалены неиспользуемые функции `get_articles_from_archive_search` и `fetch_articles_in_date_range`, отвечавшие за работу со старой версией архива сайта.
2.  **`requirements.txt`**:
    *   Удалена зависимость `feedparser`, так как парсинг RSS-лент не используется.
3.  **`scripts/`**:
    *   Полностью очищена от старых скриптов миграции, заполнения и синхронизации, которые не соответствуют новой, упрощенной логике.

---

### 2025-08-05 - Оптимизация и интеграция фоновой сверки с архивом

**Описание:**
Для повышения надежности и эффективности сбора данных была проведена кардинальная оптимизация механизма сверки с архивом. Вместо полного сканирования всего архива теперь запрашиваются только новые статьи. Эта оптимизированная логика была интегрирована в бота как фоновая задача.

**Изменения:**
1.  **`src/database.py`**:
    *   Добавлены новые функции `get_latest_article_timestamp` и `get_article_urls_in_range` для реализации оптимизированной сверки.
2.  **`scripts/daily_archive_check.py`**:
    *   Скрипт полностью переписан для использования новой, оптимизированной логики. Теперь он запрашивает только данные за период с момента последней сохраненной статьи.
3.  **`src/parser.py`**:
    *   Оптимизированная логика сверки вынесена в новую публичную функцию `sync_archive()`.
4.  **`src/bot.py`**:
    *   В основной цикл бота добавлена новая повторяющаяся задача, которая запускает `sync_archive()` каждые 4 часа. Это гарантирует, что бот не пропустит статьи, даже если они не попали на главную страницу.

---

### 2025-08-07 - feat(ai): Переход на модель gemini-2.0-flash-thinking-exp-01-21

**Описание:**
В рамках планового обновления была произведена миграция с модели `gemini-1.5-flash-latest` на экспериментальную `models/gemini-2.0-flash-thinking-exp-01-21`. Это изменение направлено на повышение скорости и качества генерируемых резюме.

**Изменения:**
1.  **Рефакторинг конфигурации:**
    *   Имя модели было вынесено из кода (`src/summarizer.py`, `src/telegram_token_checker.py`) в централизованный файл конфигурации `src/config.py`.
    *   Теперь имя модели загружается из переменной окружения `GEMINI_MODEL_NAME`, что упрощает будущие обновления.
    *   В `.env.example` добавлена соответствующая переменная.
2.  **Обновление модели:**
    *   В локальной конфигурации `.env` значение `GEMINI_MODEL_NAME` было изменено на `models/gemini-2.0-flash-thinking-exp-01-21`.
3.  **Тестирование:**
    *   Проведены юнит-тесты и ручное тестирование для подтверждения корректной работы с новой моделью.
4.  **Версионирование:**
    *   Версия проекта обновлена до `v1.2.0` для отражения значительных изменений.

---

### 2025-08-04 - Реструктуризация и новые правила

**Описание:**
Создана папка `devAI` для хранения файлов, связанных с разработкой AI. Введены новые правила планирования.

**Изменения:**
1.  **Создана папка `devAI`.**
2.  **Перемещены `GEMINI.md` и `developer_log.md` в `devAI`.**
3.  **Создан файл `devAI/PLANNING.md` с новыми правилами планирования.**
4.  **Обновлен `GEMINI.md`:**
    *   Добавлена информация о папке `devAI` в структуру проекта.
    *   Добавлен новый раздел "Правила планирования".

---

### 2025-08-04 - Корректировка приветственного сообщения

**Описание:**
Исправлена пунктуация в приветственном сообщении команды `/start` для улучшения читаемости и общего стиля.

**Изменения:**
1.  **`src/bot.py`**:
    *   В функции `start` обновлен `welcome_text`: добавлена запятая после обращения "сударь" и убраны лишние восклицательные знаки в конце.

---

### 2025-08-04 - Создание юнит-тестов

**Описание:**
Для обеспечения стабильности и надежности проекта при дальнейших изменениях были созданы юнит-тесты для ключевых модулей: `parser.py`, `summarizer.py` и `bot.py`.

**Изменения:**
1.  **`tests/test_parser.py`**:
    *   Написаны тесты для функций `get_article_text` и `get_articles_from_page`.
    *   Использовано мокирование `requests.get` для имитации HTTP-запросов и ответов, что делает тесты независимыми от доступности сайта.
2.  **`tests/test_summarizer.py`**:
    *   Написаны тесты для функции `summarize_text_local`.
    *   Использовано мокирование API-вызовов к Google Gemini и OpenRouter для изоляции и тестирования логики переключения между API и обработки ошибок.
3.  **`tests/test_bot.py`**:
    *   Написаны тесты для основных команд бота (`/start`, `/status`, `/check_now`) и для основной логики `check_and_post_news`.
    *   Использован `asyncio` и асинхронные моки для тестирования асинхронного кода бота.
    *   Замокированы все внешние зависимости (API, база данных) для тестирования логики бота в изоляции.

**Проблемы и решения в процессе разработки:**
*   Возникали ошибки `ModuleNotFoundError` при запуске тестов. Проблема была решена путем использования `pytest` вместо `unittest`, так как `pytest` лучше справляется с обнаружением тестов и управлением путями.
*   Тесты для `summarizer.py` падали из-за использования реальных API-ключей вместо моков. Проблема была решена путем прямого патчинга переменных в модуле `summarizer` во время тестов.
*   Тест `test_summarize_all_fail` в `test_summarizer.py` падал из-за неверной обработки `tenacity.RetryError`. Проблема была решена путем рефакторинга функции `summarize_text_local` для правильной обработки этого исключения.

---

### 2025-08-04 - Реализация системы аналитических дайджестов и меню команд

**Описание:**
Внедрен новый, мощный функционал для создания аналитических дайджестов новостей за различные периоды (день, неделя, месяц, год). Для удобства администратора все новые команды были добавлены в меню бота.

**Изменения:**
1.  **`src/database.py`**:
    *   Модифицирована таблица `articles` для хранения кратких сводок (`summary`).
    *   Создана новая таблица `digests` для сохранения сгенерированных дайджестов.
    *   Добавлены функции `add_digest`, `get_summaries_for_period`, `get_digests_for_period`.
2.  **`src/summarizer.py`**:
    *   Добавлены функции `create_digest` и `create_annual_digest` с продвинутыми промптами для генерации аналитических текстов на основе сводок.
3.  **`src/bot.py`**:
    *   Основная логика `check_and_post_news` обновлена для сохранения сводки каждой статьи в БД.
    *   Реализованы новые администраторские команды: `/daily_digest`, `/weekly_digest`, `/monthly_digest`, `/annual_digest`.
    *   Добавлена функция `post_init` для автоматической установки и обновления меню команд для обычных пользователей и администратора при запуске бота.

**Проблемы и решения в процессе разработки:**
*   Возникла серьезная проблема с запуском бота после внесения изменений. Логи показывали, что бот не может загрузить переменные из `.env` файла.
*   **Диагностика:** Путем последовательного добавления отладочного логирования в `bot.py` и `config.py` было установлено, что скрипт, запущенный напрямую (`python3 src/bot.py`), не мог найти `.env` файл.
*   **Решение:** Проблема была решена путем возврата к штатному способу запуска проекта через `docker-compose`. После пересборки образа (`docker-compose build`) и перезапуска контейнера (`docker-compose up -d`) `docker-compose` корректно передал все переменные окружения в контейнер, и бот успешно запустился с новым функционалом.

---

### 2025-08-04 - Рефакторинг БД и создание системы дайджестов

**Описание:**
Была проведена кардинальная переработка структуры базы данных для более чистого и масштабируемого хранения данных. Вместо одной таблицы `articles` с полем `summary` были созданы две отдельные таблицы: `articles` для основной информации и `summaries` для резюме. Это позволило реализовать систему генерации и хранения аналитических дайджестов за разные периоды.

**Изменения:**
1.  **`src/database.py`**:
    *   Полностью переписан для работы с новой двухтабличной схемой (`articles` и `summaries`).
    *   Добавлены функции `add_summary` и `has_summary`.
    *   Функция `add_article` теперь возвращает ID статьи.
2.  **Скрипты миграции и наполнения:**
    *   Создан и выполнен скрипт `scripts/migrate_db_v2.py` для миграции существующей базы данных на новую схему.
    *   Создан и выполнен скрипт `scripts/create_summaries_from_main_page.py` для первоначального наполнения таблицы `summaries`.
3.  **Система дайджестов:**
    *   Создан скрипт `scripts/generate_digests.py` для генерации и сохранения в БД суточных, недельных и месячных дайджестов.
    *   Проведена демонстрация трех разных форматов дайджестов (простая сводка, аналитический дайджест, главная новость) и отправка примеров администратору.

**Проблемы и текущий статус:**
*   **Проблема:** При попытке сгенерировать дайджест за 3 августа 2025 года выяснилось, что в базе данных отсутствуют статьи за этот день.
*   **Диагностика:** Прямой запрос к БД и повторный запуск скрипта `backfill.py` для диапазона с 28 июля по 4 августа подтвердили, что парсер не находит статей в архиве сайта `warandpeace.ru` за эти даты.
*   **Текущий статус:** Работа приостановлена в ожидании появления новостей за пропущенный период в архиве сайта. Основной функционал по работе с БД и генерации дайджестов реализован и готов к использованию.