{% extends "base.html" %}

{% block title %}Статистика сессии - {{ super() }}{% endblock %}

{% block content %}
    <header class="page-header">
        <h1>Статистика текущей сессии</h1>
        <p class="muted">Метрики работы бота с момента последнего перезапуска.</p>
    </header>

    <section id="stats-root">
        <div class="grid">
            <article>
                <h4>Исходящих HTTP‑запросов</h4>
                <h2><b><span id="http-count">{{ stats.external_http_requests | int }}</span></b></h2>
            </article>
            <article>
                <h4>Обработано новостей</h4>
                <h2><b><span id="articles-count">{{ stats.articles_processed | int }}</span></b></h2>
            </article>
            <article>
                <h4>Потрачено токенов (prompt)</h4>
                <h2><b><span id="tokens-prompt">{{ stats.tokens_prompt | int }}</span></b></h2>
            </article>
            <article>
                <h4>Потрачено токенов (completion)</h4>
                <h2><b><span id="tokens-completion">{{ stats.tokens_completion | int }}</span></b></h2>
            </article>
        </div>

        <div class="card mt-16">
            <h3 class="mt-0">Токены по ключам</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Провайдер</th>
                        <th>Ключ</th>
                        <th>Кол-во запросов</th>
                        <th>Prompt</th>
                        <th>Completion</th>
                    </tr>
                </thead>
                <tbody id="token-keys-body">
                    {% for row in stats.token_keys %}
                    <tr>
                        <td>{{ row.provider }}</td>
                        <td>{{ row.key_id }}</td>
                        <td>{{ row.requests | int }}</td>
                        <td>{{ row.prompt | int }}</td>
                        <td>{{ row.completion | int }}</td>
                    </tr>
                    {% endfor %}
                    {% if not stats.token_keys %}
                    <tr>
                        <td colspan="5" class="muted pad-8">Ключи не использовались</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <article>
            <h4>Детали</h4>
            <p>Время начала сессии: <span id="session-start">{{ stats.session_start or '—' }}</span></p>
            <p>Аптайм: <span id="uptime">{{ (stats.uptime_seconds or 0) // 3600 }}ч {{ ((stats.uptime_seconds or 0) % 3600) // 60 }}м</span></p>
            <p class="muted mt-8">
                История по дням: <a href="/stats/history">открыть</a>
            </p>
        </article>
    <section>
    </section>
    <script src="/static/stats.js"></script>
{% endblock %}
