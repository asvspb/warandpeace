{% extends "base.html" %}

{% block title %}Статистика сессии - {{ super() }}{% endblock %}

{% block content %}
    <header style="margin-bottom: 24px;">
        <h1>Статистика текущей сессии</h1>
        <p class="muted">Метрики работы бота с момента последнего перезапуска.</p>
    </header>

    <section id="stats-root">
        <div class="grid">
            <article>
                <h4>Исходящих HTTP‑запросов</h4>
                <h2><b><span id="http-count">{{ stats.external_http_requests | int }}</span></b></h2>
            </article>
            <article>
                <h4>Обработано новостей</h4>
                <h2><b><span id="articles-count">{{ stats.articles_processed | int }}</span></b></h2>
            </article>
            <article>
                <h4>Потрачено токенов (prompt)</h4>
                <h2><b><span id="tokens-prompt">{{ stats.tokens_prompt | int }}</span></b></h2>
            </article>
            <article>
                <h4>Потрачено токенов (completion)</h4>
                <h2><b><span id="tokens-completion">{{ stats.tokens_completion | int }}</span></b></h2>
            </article>
        </div>

        <div class="card" style="margin-top: 16px;">
            <h3 style="margin-top:0;">Токены по ключам</h3>
            <table class="table" style="width:100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">Провайдер</th>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">Ключ</th>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">Кол-во запросов</th>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">Prompt</th>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid var(--border);">Completion</th>
                    </tr>
                </thead>
                <tbody id="token-keys-body">
                    {% for row in stats.token_keys %}
                    <tr>
                        <td style="padding:8px;">{{ row.provider }}</td>
                        <td style="padding:8px;">{{ row.key_id }}</td>
                        <td style="padding:8px;">{{ row.requests | int }}</td>
                        <td style="padding:8px;">{{ row.prompt | int }}</td>
                        <td style="padding:8px;">{{ row.completion | int }}</td>
                    </tr>
                    {% endfor %}
                    {% if not stats.token_keys %}
                    <tr>
                        <td colspan="5" class="muted" style="padding:8px;">Ключи не использовались</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <article>
            <h4>Детали</h4>
            <p>Время начала сессии: <span id="session-start">{{ stats.session_start or '—' }}</span></p>
            <p>Аптайм: <span id="uptime">{{ (stats.uptime_seconds or 0) // 3600 }}ч {{ ((stats.uptime_seconds or 0) % 3600) // 60 }}м</span></p>
        </article>
    <section>
    </section>
    <script src="/static/stats.js"></script>
{% endblock %}
